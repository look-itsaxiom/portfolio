services:
  portfolio-web:
    build: ./web
    container_name: portfolio-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./web/data:/app/data
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-openrouter/free}
      - QDRANT_URL=http://qdrant:6333
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-nomic-embed-text}
      - DISCORD_BOT_URL=http://ask-axiom-bot:3100
      - REVALIDATE_SECRET=${REVALIDATE_SECRET}
      - NODE_ENV=production
    networks:
      - edge
    depends_on:
      - qdrant
      - ask-axiom-bot

  portfolio-admin:
    build: ./admin
    container_name: portfolio-admin
    restart: unless-stopped
    ports:
      - "3200:3200"
    volumes:
      - ./web/data:/app/data
    environment:
      - ADMIN_SECRET=${ADMIN_SECRET}
      - QDRANT_URL=http://qdrant:6333
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-nomic-embed-text}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-ask-axiom-knowledge}
      - REVALIDATE_SECRET=${REVALIDATE_SECRET}
      - PORTFOLIO_WEB_URL=http://portfolio-web:3000
      - DATA_DIR=/app/data
      - PORT=3200
    networks:
      - edge
    depends_on:
      - qdrant

  ask-axiom-bot:
    build: ./discord-bot
    container_name: ask-axiom-bot
    restart: unless-stopped
    ports:
      - "3100:3100"
    environment:
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - DISCORD_USER_ID=${DISCORD_USER_ID}
      - NEXTJS_CALLBACK_URL=http://portfolio-web:3000/api/discord-callback
    networks:
      - edge

  qdrant:
    image: qdrant/qdrant:latest
    container_name: portfolio-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant-data:/qdrant/storage
    networks:
      - edge

networks:
  edge:
    external: true
